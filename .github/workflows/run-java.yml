name: Run Java Project

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      main_class:
        description: 'Main class to run (for plain .java projects). Example: com.example.App or Main'
        required: false
        default: Main

jobs:
  build-and-run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java 17 (Temurin)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Show repo files (for debugging)
        run: ls -la

      - name: Build & run (Maven / Gradle / javac fallback)
        env:
          MAIN_CLASS_INPUT: ${{ github.event.inputs.main_class }}
        run: |
          set -e

          # Determine main class (fallback to 'Main' if empty)
          MAIN="${MAIN_CLASS_INPUT}"
          if [ -z "$MAIN" ]; then
            MAIN="Main"
          fi
          echo "Using MAIN class: $MAIN"

          if [ -f pom.xml ]; then
            echo "Detected pom.xml — building with Maven"
            mvn -B -DskipTests package
            # run any jar in target (adjust if your project produces a different artifact)
            JAR=$(ls target/*.jar | head -n1 || true)
            if [ -n "$JAR" ]; then
              echo "Running $JAR"
              java -jar "$JAR"
            else
              echo "No jar found in target/. You may need to adjust the maven packaging or run class directly."
              exit 1
            fi

          elif [ -f build.gradle ] || [ -f build.gradle.kts ]; then
            echo "Detected Gradle build — running Gradle wrapper"
            chmod +x ./gradlew || true
            ./gradlew build -x test
            JAR=$(ls build/libs/*.jar | head -n1 || true)
            if [ -n "$JAR" ]; then
              echo "Running $JAR"
              java -jar "$JAR"
            else
              echo "No jar found in build/libs/. You may need to adjust Gradle build settings."
              exit 1
            fi

          else
            echo "No pom.xml or build.gradle detected — compiling plain .java files"
            # compile all .java into out/ and run given MAIN class
            mkdir -p out
            find . -name "*.java" > sources.txt
            if [ ! -s sources.txt ]; then
              echo "No .java sources found"
              exit 1
            fi
            javac -d out @sources.txt
            echo "Running class $MAIN"
            java -cp out "$MAIN"
          fi
